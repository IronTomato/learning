记一次log4j2问题的发现和解决
==============================

多个心眼
---------

前段时间的一项工作内容，由于涉及敏感操作，因此每一个步骤都要记录详细的日志，一旦出现问题，能够精确地追踪。
项目使用log4j，是我进入项目组之前就配置好的，我只要直接使用，之前其他任务时也使用过，因此没有给予过多关注。

编码大致完成后，我打算试试效果，流程没有问题，控制台也正确打印了日志。不过控制台日志毕竟只是调试时用的，真正记录日志的应该是日志文件，
于是我打算确认一下日志文件是不是正确打印。

两个配置文件的疑惑
----------------

我要去Log4j的配置文件里查看日志文件的输出路径，可是当我打开项目配置文件目录，却发现有log4j.properties和log4j2.xml两个Log4j的配置文件。  
我学过一点Log4j 1.2.17，这里的log4j.properties正是我熟悉的格式，而另一个从字面判断应该是Log4j2的配置文件，莫非项目中同时使用了Log4j2和Log4j1？又或者这两个配置文件只有一个生效？  

我分别修改了两个配置文件中的日志输出格式，再启动项目运行查看输出日志，发现两个配置文件中配置的格式分别都有输出。  
从日志输出的内容来看，情况是这样的，由于项目引用的第三方库依赖log4j 1.x作为日志组件，所以要配置log4j.properties使得第三方库的日志能够正确输出，而我们项目本身使用log4j2作为日志组件。  
又看了一眼Maven配置文件，其中有对log4j2-core 2.0-beta7的显示引用。  
看到在公司的项目中使用beta版组件，让我颇为诧异，因为我即使在个人项目中也会尽量避免beta版而使用正式版或者稳定版，何况项目组长还是个在技术上相当保守的人。  
总之，这个log4j2.xml是我要找的配置文件，我没有学过Log4j2，不过xml格式的文档还是很好懂的，其中有个FastRollingFileAppender一看就是写文件的，从它的配置项中，我找到了日志文件的输出路径。
找到日志文件打开查看后，确认日志都正常输出到文件了。  

如果事情就这样结束了，那就太简单了。

消失的日志
-----------

调试阶段我将日志的输出等级设为debug，因为有一些debug级别的日志需要确认，然而第三方组件输出的debug日志太多了，就像刷屏一样，我关注的日志瞬间就被淹没了。

此时，我想起了前段时间刚刚网上找到的一款开源的日志查看工具OtrosLogViewer刚好可以试用一下。
OtrosLogViewer可以根据日志等级、输出日志的类、时间、日志内容等多种条件过滤显示的日志，并且可以实时监视日志文件中新加入的日志，看它就跟看控制台一样，不过更清晰。
我设置了过滤条件只显示我的新功能的日志，然后再次测试，日志正确的出现在了OtrosLogViewer中，我很满意，想着如果之后让我分析日志排查问题我就这么干。

之后我继续测试，每次也都查看日志。在一次重启项目之后，问题出现了，OtrosLogViewer中不再出现新的日志！但是程序运行一切正常，控制台也都正确输出了日志。我的第一反应是工具有问题，我取消了过滤条件，显示所有日志，依然没有新日志，直接使用文本编辑器打开日志文件，也没有新日志。搜索本应出现的那条日志的关键字，神奇的事情出现了，居然搜到了，而且看这条日志的时间，的确是最新的一条，不过它不是出现在日志文件的最后，而是出现在了中间。上下扫了一眼日志时间，发现时间顺序是混乱的，这太诡异了，我意识到可能是log4j2写入文件的时候有问题。
配置文件中写入文件使用的是FastRollingFileAppender，问题可能出在它身上，这个Appender我不了解，于是去官方的在线文档（http://logging.apache.org/log4j/2.x/manual/appenders.html）寻求资料。
我发现在线文档介绍的是最新版（目前是2.6.1）的情况，而其中根本没有FastRollingFileAppender，我在另一个项目里引用最新版的包，输入FastRollingFileAppender并使用IDE的自动完成功能去搜索这个类的完整路径，结果发现没有这个类。新版库中删除了旧版库中的某个类并不奇怪，这说明那个类很可能是有问题的，尤其这个旧版还是beta版而非正式版。
既然官方文档没有介绍，我就借助搜索引擎，查了几条都是介绍如何使用的，没有提到什么注意事项或有什么问题之类的特别有价值的信息。

在自己摸索陷入困境的时候，我想到可以问一下当初写这个配置文件的人，他应该会比较熟悉。查看SVN历史记录，我发现这个配置文件的提交版本号是项目最早的那个版本号，这意味着它是随着项目第一次导入SVN版本库时一起导入的，那已经了两年前的事了，说明两年来都没有人修改过这个文件，而提交文件的那个人早已离职了。
我决定放弃修改FastRollingFileAppender配置的想法，另外配置一个RollingFileAppender，输出到另一个文件。OtrosLogViewer载入新的日志文件，成功读取到了日志的实时更新，并且即使项目重启也都正常。将两个日志文件一对比，差别就比较明显了，我对两者配置了同样的输出格式和输出等级，两个文件内容理应完全一致的，但是从文件大小上就看出了差别，FastRollingFileAppender的文件更小，说明它丢失了一些日志。
我想这个项目已经上线好久了，如果日志文件不能正常输出，理应早就被发现了，莫非是我本地环境的问题？于是我去问我的开发组组长，他是这个项目的主要负责人，项目新版本部署上线以及线上出问题都归他管。
我问他线上的日志是否正确的打印到文件，他告诉我，日志是可以输出到文件，但是有一个问题，就是每次重新启动项目时，如果原来的日志文件还存在，就不能正常输出，需要重命名并转移旧日志文件再启动项目。看来这不是我本地的环境问题，而是一个一直存在的问题，并且被容忍了很久。我告诉组长，我在配置文件里加了配置项可以解决这个问题，保险起见，原来的配置没有删除，所以会输出两份日志。

回到自己的工位，有件事情还是如鲠在喉，到底那个在新版中消失FastRollingFileAppender有什么问题，为什么我们项目还在一直用它。
我到Maven中心仓库下载了我们用的版本log4j2-core 2.0-beta7以及之后几个版本的Javadoc文档，发现在beta7和beta8版本中是存在FastRollingFileAppender的，而beta9之后版本中就不存在了。
这更加坚定了我的想法：FastRollingFileAppender由于存在缺陷而在新版中被剔除了。
再次借助搜索引擎，我发现我上次只把注意力放在中文资料上，而忽视了更为重要的英文结果。其中一个链接的标题中的“Rename”引起了我的注意，重命名似乎也是一个导致类看起来不见了的很合理的原因，想点开链接查看详细，却发现链接已经无法打开。以“Rename FastRollingFileAppender”作为关键字再次搜索，[这篇文章](https://blogs.apache.org/logging/)出现在了搜索结果中，在其中搜索“FastRollingFileAppender”得到了非常有价值的信息。
我得知，FastRollingFileAppender在log4j2 2.0-beta9中已经被重命名为RollingRandomAccessFileAppender，这个Appender一直存在到现在，官方在线文档中也有关于它的介绍；另外，log4j2 2.0-beta8修正了几个关于FastRollingFileAppender的bug，其中包括

> LOG4J2-292: Fast(Rolling)FileAppender now correctly appends to (does not overwrite) existing file.  

这说明，此前FastRollingFileAppender的确存在不能正确写入到已存在的日志文件的问题，这被确认为一个bug并且在log4j2 2.0-beta8中被修复，而我们项目中用的刚好是log4j2 2.0-beta7，是存在问题的版本。

我修改了pom.xml文件，将依赖的包改为log4j2 2.0-beta8，再次运行项目，输出的两个日志文件都正常，重启项目，同样正常。