记一次log4j2问题的发现和解决
==============================

第一次写这种总结文，写完发现完全是流水账，而且花费的时间比我想象的多的多，又花了一些时间修改，当做是练笔吧，希望以后能有所提高。


多个心眼
---------

前段时间的一项工作内容，由于涉及敏感操作，因此每一个步骤都要记录详细的日志，一旦出现问题，能够精确地追踪。  
项目使用log4j，是我进入项目组之前就配置好的，我只要直接使用，之前其他任务时也使用过，因此没有给予过多关注。

编码大致完成后，我打算试试效果，流程没有问题，控制台也正确打印了日志。不过控制台日志毕竟只是调试时用的，真正记录日志的应该是日志文件，
于是我打算确认一下日志文件是不是正确打印。

两个配置文件的疑惑
----------------

我要去Log4j的配置文件里查看日志文件的输出路径，可是当我打开项目配置文件目录，却发现有log4j.properties和log4j2.xml两个Log4j的配置文件。  
我学过一点Log4j 1.2.17，这里的log4j.properties正是我熟悉的格式，而另一个从字面判断应该是Log4j2的配置文件，莫非项目中同时使用了Log4j2和Log4j1？又或者这两个配置文件只有一个生效？  

我分别修改了两个配置文件中的日志输出格式，再启动项目运行查看输出日志，发现两个配置文件中配置的格式分别都有输出。  
从日志输出的内容来看，情况是这样的，由于项目引用的第三方库依赖log4j 1.x作为日志组件，所以要配置log4j.properties使得第三方库的日志能够正确输出，而我们项目本身使用log4j2作为日志组件。  
又看了一眼Maven配置文件，其中有对log4j2-core 2.0-beta7的显示引用。  
看到在公司的项目中使用beta版组件，让我颇为诧异，因为我即使在个人项目中也会尽量避免beta版而使用正式版或者稳定版，何况项目组长还是个在技术上相当保守的人。  
总之，这个log4j2.xml是我要找的配置文件，我没有学过Log4j2，不过xml格式的文档还是很好懂的，其中有个FastRollingFileAppender一看就是写文件的，从它的配置项中，我找到了日志文件的输出路径。
找到日志文件打开查看后，确认日志都正常输出到文件了。  

如果事情就这样结束了，那就太简单了。

消失的日志
-----------

之后我继续进行测试，在一次重启项目之后，问题出现了，日志文件没有任何新增的日志！但是程序运行一切正常，控制台也都正确输出了日志。  
我在日志文件里搜索本应出现的那条日志的关键字，居然搜到了，而且从这条日志的时间来看，的确是最新的一条，不过它不是出现在日志文件的最后，而是出现在了中间。上下扫了一眼日志时间，发现时间顺序是混乱的，我意识到可能是log4j2写入文件的时候有问题。
配置文件中写入文件使用的是FastRollingFileAppender，我对这个Appender的写入策略不了解，于是去官方的在线文档（http://logging.apache.org/log4j/2.x/manual/appenders.html）寻求资料。
在线文档介绍的是最新版（目前是2.6.1）的情况，而其中根本没有FastRollingFileAppender，我在另一个项目里引用最新版的包，使用IDE的类搜索功能去搜索FastRollingFileAppender，结果发现没有这个类。此时我想到，这有可能是一个有缺陷的类，所以在新版中被删除了。  
既然官方文档没有介绍，我就借助搜索引擎，查到几条使用示例，与项目目前使用的没有太大区别，对解决问题没有什么帮助。

寻求帮助
--------

在自己摸索陷入困境的时候，我想可以询问一下这个配置文件的作者。通过查看SVN历史记录，我发现这个配置文件的提交版本号是项目最早的那个版本号，这意味着它是随着项目第一次导入SVN版本库时一起导入的，那已经了两年前的事了，说明两年来都没有人修改过这个文件，而提交文件的那个人早已离职了。  
我决定放弃修改FastRollingFileAppender配置的想法，另外配置一个RollingFileAppender，输出到另一个文件。新的日志工作一切正常，即使项目重启也都正常。
目前这个项目是已经上线的项目，日志系统也在线上环境运行了好久了，我想项目中使用FastRollingFileAppender可能是出于某种我不知道的原因。于是我去问开发组长，他是这个项目的主要负责人，项目新版本部署也由他负责。
我问他线上的日志是否正确的打印到文件，他告诉我，日志是可以输出到文件，但是有一个问题，就是每次重新启动项目时，如果原来的日志文件还存在，就不能正常输出，需要重命名并转移旧日志文件再启动项目。  
我此时终于明白，我发现了一个系统中长久以来存在的问题，但是一直被容忍和忽略了，没有人去解决。
我告诉组长，我在配置文件里加了配置项可以解决这个问题，保险起见，原来的配置没有删除，所以会输出两份日志。

追查原因
--------

回到自己的工位，有几件事情还是如鲠在喉，到底那个FastRollingFileAppender是什么？新版中为何消失不见？我们项目当初为什么要使用它？  
我到Maven中心仓库下载了我们使用的版本log4j2-core 2.0-beta7以及之后几个版本的Javadoc文档，发现在beta7和beta8版本中是存在FastRollingFileAppender的，而beta9之后版本中就不存在了。
这更加坚定了我的想法：FastRollingFileAppender由于存在缺陷而在新版中被剔除了。
再次借助搜索引擎，我发现我上次只把注意力放在中文资料上，而忽视了更为重要的英文结果。其中一个链接的标题中的“Rename”引起了我的注意，重命名似乎也是一个导致类看起来不见了的很合理的原因，想点开链接查看详细，却发现链接已经无法打开。以“Rename FastRollingFileAppender”作为关键字再次搜索，[[这篇文章](https://blogs.apache.org/logging/)]出现在了搜索结果中，在其中搜索“FastRollingFileAppender”得到了非常有价值的信息。
我得知，  

* FastRollingFileAppender在log4j2 2.0-beta9中已经被重命名为[RollingRandomAccessFileAppender](http://logging.apache.org/log4j/2.x/manual/appenders.html#RollingRandomAccessFileAppender)，这个Appender一直存在到现在，官方在线文档中也有关于它的介绍；
* log4j2 2.0-beta8修正了几个关于FastRollingFileAppender的bug，其中包括
	
	> LOG4J2-292: Fast(Rolling)FileAppender now correctly appends to (does not overwrite) existing file.  
	
	这说明，此前FastRollingFileAppender的确存在不能正确写入到已存在的日志文件的问题，这被确认为一个bug并且在log4j2 2.0-beta8中被修复，而我们项目中用的刚好是log4j2 2.0-beta7，是存在问题的版本。

我修改了pom.xml文件，将依赖的包改为log4j2 2.0-beta8，再次运行项目，输出的两个日志文件都正常，重启项目，同样正常。

水落石出
--------

通过对Maven中心仓库中的Log4j2以及我们的项目进行了一点考古，我大概推出了事情的经过。  
项目中Log4j2.xml配置文件随着整个项目第一次导入到目前的SVN版本库，那是在2014年5月，考虑到初始导入的代码规模，项目此前已经开发了一段时间。  
Log4j2.0正式版在2014年7月发布，所以当项目开发者为系统引入日志组件时，Log4j 2.0-beta7很可能是当时的最新版，当时的开发者为了图新鲜，不负责任地引入了一个不稳定版本的组件，同时也没有花更多的时间去研究，从FastRollingFileAppender的使用情况来看，几乎就是照搬了网络上的样例代码。  
而在之后的时间里，由于开发人员对日志系统的不重视与不关心，即使发现问题也不曾想去解决，最终导致一个问题长期存在。